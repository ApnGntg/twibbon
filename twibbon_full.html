<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Twibbon Maker — Simple</title>
  <style>
    :root{--accent:#2b6cb0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0; padding:16px; background:#f6f8fb; color:#111}
    .wrap{max-width:980px; margin:0 auto; display:grid; grid-template-columns:1fr 420px; gap:16px}
    header{grid-column:1/-1; display:flex; align-items:center; gap:12px}
    h1{font-size:18px; margin:0}
    p.lead{margin:0; color:#555}
    .card{background:white; border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(20,30,60,0.06)}
    .left{display:flex; flex-direction:column; gap:12px}
    .preview{width:100%; aspect-ratio:1/1; background:linear-gradient(180deg,#e9eef8,#fff); border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden}
    canvas{width:100%; height:auto; display:block}
    .controls{display:flex; flex-direction:column; gap:8px}
    .frames{display:flex; gap:8px; flex-wrap:wrap}
    .frame-thumb{width:80px; height:80px; border-radius:8px; background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; border:2px solid transparent}
    .frame-thumb.selected{border-color:var(--accent)}
    label.btn{display:inline-block; padding:8px 12px; background:var(--accent); color:white; border-radius:8px; cursor:pointer}
    input[type=file]{display:none}
    .right .panel{display:flex; flex-direction:column; gap:8px}
    .row{display:flex; gap:8px; align-items:center}
    .text-controls{display:flex; gap:6px; align-items:center}
    .small{font-size:12px;color:#666}
    @media (max-width:900px){.wrap{grid-template-columns:1fr; padding-bottom:40px}}
  </style>
  <!-- Cropper.js CDN -->
  <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Twibbon Maker</h1>
      <p class="lead">Upload foto → crop → pilih frame → tambah teks → download. (Responsive & mobile-friendly)</p>
    </header>

    <section class="left card">
      <div class="controls">
        <div class="row">
          <label class="btn" for="photoInput">Upload Foto</label>
          <input id="photoInput" type="file" accept="image/*" />
          <button id="useCamera" class="btn" style="background:#38a169">Camera</button>
          <button id="cropBtn" class="btn" style="background:#805ad5">Apply Crop</button>
          <button id="clearBtn" class="btn" style="background:#e53e3e">Clear</button>
        </div>
        <div class="small">Preview (square 1:1). Foto akan diekspor sebagai 1080×1080 PNG.</div>
      </div>

      <div class="preview card" id="previewWrap">
        <div id="cropArea" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
          <img id="photoPreview" src="" alt="" style="max-width:100%; display:none;" />
          <canvas id="resultCanvas" width="1080" height="1080" style="display:none"></canvas>
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="downloadBtn" class="btn" style="flex:1">Download PNG</button>
        <button id="shareBtn" class="btn" style="background:#ed8936">Share (Web Share)</button>
      </div>
    </section>

    <aside class="right">
      <div class="card panel">
        <h3 style="margin:0">Pilih Frame</h3>
        <div class="frames" id="framesList">
          <!-- Thumbnails (inline SVG frames) -->
          <div class="frame-thumb selected" data-frame="frame1" title="Frame Simple" id="thumb-frame1">
            <svg width="72" height="72" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
              <rect width="200" height="200" rx="18" fill="none" stroke="#2b6cb0" stroke-width="14" />
              <circle cx="100" cy="80" r="52" fill="#fff" stroke="#2b6cb0" stroke-width="8" />
            </svg>
          </div>

          <div class="frame-thumb" data-frame="frame2" title="Frame Ribbon" id="thumb-frame2">
            <svg width="72" height="72" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
              <rect width="200" height="200" rx="18" fill="#fff" />
              <path d="M0 0 L200 0 L200 40 L0 40 Z" fill="#e53e3e" />
              <path d="M0 160 L200 160 L200 200 L0 200 Z" fill="#2b6cb0" />
              <circle cx="100" cy="100" r="72" fill="none" stroke="#000" stroke-width="6" opacity="0.06" />
            </svg>
          </div>

          <label class="frame-thumb" title="Upload Frame">
            <input id="frameUpload" type="file" accept="image/*" style="display:none" />
            <div style="text-align:center; font-size:12px; color:#777">+ Add</div>
          </label>
        </div>

        <hr />

        <h3 style="margin:0">Teks (optional)</h3>
        <div class="text-controls">
          <input id="textInput" placeholder="Masukkan teks..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd" />
          <input id="fontSize" type="number" value="48" min="12" max="200" style="width:84px;padding:8px;border-radius:8px;border:1px solid #ddd" />
        </div>
        <div class="row">
          <label class="small">Drag teks pada preview untuk pindah. Ketuk 'Apply Crop' setelah upload foto.</label>
        </div>

        <hr />

        <div class="row"><strong>Advanced</strong></div>
        <div class="row small">Export: 1080×1080 PNG — cocok untuk Instagram.</div>
        <div class="row" style="margin-top:8px">
          <button id="pwaGuide" class="btn" style="background:#4a5568">Cara jadi PWA</button>
        </div>
      </div>
    </aside>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script>
    // Elements
    const photoInput = document.getElementById('photoInput')
    const photoPreview = document.getElementById('photoPreview')
    const cropArea = document.getElementById('cropArea')
    const cropBtn = document.getElementById('cropBtn')
    const clearBtn = document.getElementById('clearBtn')
    const resultCanvas = document.getElementById('resultCanvas')
    const downloadBtn = document.getElementById('downloadBtn')
    const shareBtn = document.getElementById('shareBtn')
    const framesList = document.getElementById('framesList')
    const frameUpload = document.getElementById('frameUpload')
    const textInput = document.getElementById('textInput')
    const fontSizeInput = document.getElementById('fontSize')
    const useCamera = document.getElementById('useCamera')

    let cropper = null
    let activeFrame = 'frame1'
    let customFrames = {}
    let textState = {text:'', x:540, y:960, size:48}
    let draggingText = false
    let dragOffset = {x:0,y:0}

    // Inline frames as SVG dataURLs (render at export time)
    const framesData = {
      frame1: `data:image/svg+xml;utf8,${encodeURIComponent(`<?xml version='1.0' encoding='utf-8'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1080 1080'><rect width='1080' height='1080' rx='40' fill='none' stroke='%232b6cb0' stroke-width='40'/><circle cx='540' cy='400' r='360' fill='none' stroke='%232b6cb0' stroke-width='18'/></svg>`)}`,
      frame2: `data:image/svg+xml;utf8,${encodeURIComponent(`<?xml version='1.0' encoding='utf-8'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1080 1080'><rect width='1080' height='1080' rx='32' fill='%23ffffff'/><rect y='0' width='1080' height='160' fill='%23e53e3e'/><rect y='920' width='1080' height='160' fill='%232b6cb0'/><circle cx='540' cy='540' r='420' fill='none' stroke='%23000000' stroke-width='20' opacity='0.06'/></svg>`)}`

    }

    // Initialize cropper when image loaded
    photoInput.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0]
      if(!file) return
      const url = URL.createObjectURL(file)
      loadImageToCropper(url)
    })

    // Camera capture (mobile devices)
    useCamera.addEventListener('click', ()=>{
      const captureInput = document.createElement('input')
      captureInput.type = 'file'
      captureInput.accept = 'image/*'
      captureInput.capture = 'environment'
      captureInput.onchange = (e)=>{
        const file = e.target.files && e.target.files[0]
        if(!file) return
        const url = URL.createObjectURL(file)
        loadImageToCropper(url)
      }
      captureInput.click()
    })

    function loadImageToCropper(url){
      // cleanup old
      if(cropper){ cropper.destroy(); cropper = null }
      photoPreview.src = url
      photoPreview.style.display = 'block'
      resultCanvas.style.display = 'none'
      // wait image
      photoPreview.onload = ()=>{
        // set styles so cropper fits area
        photoPreview.style.maxHeight = '100%'
        cropper = new Cropper(photoPreview, {
          viewMode: 1,
          aspectRatio: 1,
          autoCropArea: 1,
          responsive: true,
          background: false,
          zoomOnWheel: true
        })
      }
    }

    cropBtn.addEventListener('click', ()=>{
      if(!cropper) { alert('Silakan upload foto dulu.'); return }
      const canvasData = cropper.getCroppedCanvas({width:1080, height:1080, imageSmoothingQuality:'high'})
      // draw to result canvas
      const ctx = resultCanvas.getContext('2d')
      resultCanvas.width = 1080
      resultCanvas.height = 1080
      ctx.clearRect(0,0,1080,1080)
      ctx.fillStyle = '#fff'
      ctx.fillRect(0,0,1080,1080)
      ctx.drawImage(canvasData, 0, 0)
      // draw selected frame
      drawActiveFrame().then(()=>{
        // draw text
        drawTextOnCanvas()
        resultCanvas.style.display = 'block'
        photoPreview.style.display = 'none'
      })
    })

    clearBtn.addEventListener('click', ()=>{
      if(cropper){ cropper.destroy(); cropper = null }
      photoPreview.src = ''
      photoPreview.style.display = 'none'
      resultCanvas.style.display = 'none'
    })

    // Frames selection
    framesList.addEventListener('click', (e)=>{
      const thumb = e.target.closest('.frame-thumb')
      if(!thumb) return
      // handle upload input separately
      if(thumb.querySelector('input')) return
      document.querySelectorAll('.frame-thumb').forEach(t=>t.classList.remove('selected'))
      thumb.classList.add('selected')
      activeFrame = thumb.dataset.frame
    })

    // Frame upload
    frameUpload.addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0]
      if(!f) return
      const id = 'custom-' + Date.now()
      const url = URL.createObjectURL(f)
      customFrames[id] = url
      // create thumb
      const div = document.createElement('div')
      div.className = 'frame-thumb'
      div.dataset.frame = id
      const img = document.createElement('img')
      img.src = url
      img.style.maxWidth = '100%'
      img.style.maxHeight = '100%'
      div.appendChild(img)
      framesList.insertBefore(div, framesList.querySelector('label'))
      // set active
      document.querySelectorAll('.frame-thumb').forEach(t=>t.classList.remove('selected'))
      div.classList.add('selected')
      activeFrame = id
    })

    // Draw active frame to canvas
    async function drawActiveFrame(){
      const ctx = resultCanvas.getContext('2d')
      let src = framesData[activeFrame]
      if(!src){ // maybe custom
        src = customFrames[activeFrame]
      }
      if(!src) return
      await new Promise((res)=>{
        const img = new Image()
        img.crossOrigin = 'anonymous'
        img.onload = ()=>{
          // draw centered, scale to cover canvas
          ctx.drawImage(img, 0, 0, 1080, 1080)
          res()
        }
        img.onerror = ()=>{
          console.warn('Error loading frame')
          res()
        }
        img.src = src
      })
    }

    // Text handling (drag to move)
    textInput.addEventListener('input', ()=>{ textState.text = textInput.value; redrawCanvas() })
    fontSizeInput.addEventListener('input', ()=>{ textState.size = parseInt(fontSizeInput.value||48,10); redrawCanvas() })

    // detect pointer events on preview area for dragging text
    const previewWrap = document.getElementById('previewWrap')
    previewWrap.addEventListener('pointerdown', (ev)=>{
      if(resultCanvas.style.display === 'none') return
      const rect = resultCanvas.getBoundingClientRect()
      const x = (ev.clientX - rect.left) * (1080 / rect.width)
      const y = (ev.clientY - rect.top) * (1080 / rect.height)
      // check if clicked near text
      const tx = textState.x, ty = textState.y
      const dist = Math.hypot(tx - x, ty - y)
      if(dist < 120){ draggingText = true; dragOffset.x = x - tx; dragOffset.y = y - ty }
    })
    window.addEventListener('pointermove', (ev)=>{
      if(!draggingText) return
      const rect = resultCanvas.getBoundingClientRect()
      const x = (ev.clientX - rect.left) * (1080 / rect.width)
      const y = (ev.clientY - rect.top) * (1080 / rect.height)
      textState.x = x - dragOffset.x
      textState.y = y - dragOffset.y
      redrawCanvas()
    })
    window.addEventListener('pointerup', ()=>{ draggingText = false })

    function drawTextOnCanvas(){
      if(!textState.text) return
      const ctx = resultCanvas.getContext('2d')
      ctx.save()
      ctx.font = `${textState.size}px system-ui, Arial`;
      ctx.textAlign = 'center'
      ctx.fillStyle = '#ffffff'
      ctx.strokeStyle = 'rgba(0,0,0,0.5)'
      ctx.lineWidth = Math.max(3, textState.size/16)
      ctx.strokeText(textState.text, textState.x, textState.y)
      ctx.fillText(textState.text, textState.x, textState.y)
      ctx.restore()
    }

    function redrawCanvas(){
      if(resultCanvas.style.display === 'none') return
      // re-draw: base cropped image stored? For simplicity we re-crop from cropper if present, else keep canvas image
      if(cropper){
        const canvasData = cropper.getCroppedCanvas({width:1080, height:1080, imageSmoothingQuality:'high'})
        const ctx = resultCanvas.getContext('2d')
        ctx.clearRect(0,0,1080,1080)
        ctx.fillStyle = '#fff'
        ctx.fillRect(0,0,1080,1080)
        ctx.drawImage(canvasData, 0, 0)
        drawActiveFrame().then(()=>{ drawTextOnCanvas() })
      } else {
        // if no cropper (we have canvas already), just re-draw frame + text on top
        // keep existing image beneath by copying pixels
        // (no-op here)
        drawActiveFrame().then(()=>{ drawTextOnCanvas() })
      }
    }

    // Download
    downloadBtn.addEventListener('click', ()=>{
      if(resultCanvas.style.display === 'none') { alert('Silakan Apply Crop dulu') ; return }
      resultCanvas.toBlob((blob)=>{
        const a = document.createElement('a')
        a.href = URL.createObjectURL(blob)
        a.download = 'twibbon.png'
        a.click()
      }, 'image/png')
    })

    // Web Share
    shareBtn.addEventListener('click', async ()=>{
      if(resultCanvas.style.display === 'none') { alert('Silakan Apply Crop dulu'); return }
      if(navigator.canShare && navigator.canShare()){ // modern
        resultCanvas.toBlob(async (blob)=>{
          const filesArray = [new File([blob], 'twibbon.png', {type:'image/png'})]
          try {
            await navigator.share({ files: filesArray, title: 'Twibbon', text: 'Hasil Twibbon ku' })
          } catch(err){ console.warn(err) }
        })
      } else {
        alert('Web Share API tidak didukung di browser ini. Silakan unduh secara manual.')
      }
    })

    // PWA guide
    document.getElementById('pwaGuide').addEventListener('click', ()=>{
      alert('Untuk jadi PWA: buat manifest.json, tambahkan service worker untuk caching, lalu user bisa Add to Home Screen. Mau aku bantu buatkan manifest + service worker?')
    })

    // small UX: when clicking the thumbnail's inner image, make sure upload label works
    document.getElementById('thumb-frame1').addEventListener('click', ()=>{ activeFrame='frame1' })
    document.getElementById('thumb-frame2').addEventListener('click', ()=>{ activeFrame='frame2' })

  </script>
</body>
</html>
